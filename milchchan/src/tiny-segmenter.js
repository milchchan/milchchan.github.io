// TinySegmenter 0.1 -- Super compact Japanese tokenizer in Javascript
// (c) 2008 Taku Kudo <taku@chasen.org>
// TinySegmenter is freely distributable under the terms of a new BSD licence.
// For details, see http://chasen.org/~taku/software/TinySegmenter/LICENCE.txt

export function TinySegmenter() {
  var patterns = {
    "[一二三四五六七八九十百千万億兆]": "M",
    "[一-龠々〆ヵヶ]": "H",
    "[ぁ-ん]": "I",
    "[ァ-ヴーｱ-ﾝﾞｰ]": "K",
    "[a-zA-Zａ-ｚＡ-Ｚ]": "A",
    "[0-9０-９]": "N"
  }
  this.chartype_ = [];
  for (var i in patterns) {
    var regexp = new RegExp;
    regexp.compile(i)
    this.chartype_.push([regexp, patterns[i]]);
  }

  this.BIAS__ = 0.22520113688288681542;
  this.BC1__ = { "IH": -0.23848626837817804569, "II": 0.3269724300899609637, "IK": -0.010095752335862922047, "NH": 0.21727530565338304402, "OH": -0.10089986761975575091, "OO": 0.13433286358813376071 };
  this.BC2__ = { "AA": -1.2150931385052765599, "HH": -0.43298652939827053654, "HI": -0.097932986363429577747, "IH": 0.14590310223095676045, "II": -0.66256033131652891655, "IO": 0.45843674644599385903, "KI": 0.15781506553541868598, "KK": -1.1956897560492933952, "KM": -0.22093713680158005852, "NH": 0.11571381334313575462, "NN": -0.93911075801522658768, "OH": 0.11313200037786794172, "OI": 0.03204380821744945429, "OO": -1.1228293018442108142 };
  this.BC3__ = { "HH": 0.090632595183653005821, "IO": 0.061425386387191603654, "KK": 0.016982736109307103312 };
  this.BP1__ = { "BB": 0.030241123724748596169, "OB": -0.023182912087779915244, "OO": 0.014553254336939359936, "UB": 0.028185906235397895775 };
  this.BP2__ = { "OB": 0.13268109572419400921, "UB": 0.0049313063074672702779, "UU": -0.01468917069378047717 };
  this.BQ1__ = { "BII": -0.010083907026208023192, "OII": 0.025152510356623438564 };
  this.BQ2__ = { "BHH": 0.043417351611174978543, "BHI": 0.045457771888541616268, "BIH": -0.14470309077292448086, "OHH": -0.08026119156093003415, "OKK": -0.19776643210381109061, "UII": -0.066212199633300522494 };
  this.BQ3__ = { "BHH": -0.014898424180164977076, "BHI": 0.013890054125675376992, "BIH": 0.0057573285486834033242, "OHH": 0.10079747274055154971, "UOH": -0.1191250236143602953 };
  this.BQ4__ = { "BAA": -0.12647754225416779628, "BHH": -0.28209502190319146742, "BII": -0.37007121668569409323, "BOO": -0.035413738663191487999, "OHI": -0.10249592883314612157, "OIH": -0.08938538374702867384, "UHH": -0.07125565381822343558 };
  this.BW1__ = { "、と": 0.004858388849527790071, "いる": 0.046175794631203380403, "うし": -0.22072249944143948475, "から": 0.18188199901588142371, "こと": 0.23719058565400888416, "した": 0.031515899622947006475, "して": 0.17789256429030608775, "しょ": 0.14278547537084637642, "そこ": 0.10958177701368547463, "そし": -0.12268428845315280939, "たち": 0.1283336365028195647, "った": 0.23549070238427438628, "つい": -0.038507788030877974916, "てい": 0.15503016203179423305, "てき": 0.025032613497468166053, "てく": -0.034666974693214766545, "てし": -0.078503193278791433274, "でも": 0.058891466605629022579, "どこ": 0.12292245970288949442, "ない": 0.6901299739841868508, "なっ": 0.050460448267941195033, "にし": 0.16927152179892995809, "ませ": 0.15640043672788772611, "まる": -0.39133933634855577743, "よう": 0.20507061703702880728, "よっ": -0.031759037859465065468, "をし": 0.045731890956738976972, "同時": -0.33308946737473155153, "本当": -0.34218099454695616313 };
  this.BW2__ = { "——": -1.2401205264908465864, "──": -0.63011793383175795924, "いう": -0.4120504619048707684, "いた": 0.09548262290350316428, "いは": -0.32152414179508564951, "から": -0.35468172050180590826, "こと": -0.86165918020350962259, "この": -0.44599672526331651801, "させ": 0.07585377120157781039, "され": 0.99172136646508568525, "しい": -0.064268486012608497249, "した": 0.27872035286848240165, "その": -0.59165993032872821189, "たち": -0.38208193680219576516, "った": 0.15914288631941028718, "っと": -0.40801501262844352969, "てい": 0.72840658979511452298, "てく": 0.0098246762459647841992, "ては": -0.21867316408099918279, "ても": -0.056790456295066349401, "であ": 0.16567658274283686426, "でい": 0.13735555300668092493, "でき": -0.0048876059344303435933, "でし": -0.2472229636521995344, "です": -0.39008719980373701697, "とい": 0.42499475228553890149, "とこ": -0.086602205908987525684, "ない": -0.17994387867482802834, "にお": -0.10106877389976730297, "にし": 0.28471177129117031246, "にな": 0.009888420945049790356, "によ": -0.43406653745741763384, "に対": -0.99676400506115769851, "に関": -0.61674818087765526098, "のか": 0.014644397371066340818, "のに": -0.17113000695588004296, "まし": -0.050894244186635337335, "まで": -0.30234167448887550034, "まれ": 0.22494388603139339744, "もの": -1.3606475641268720445, "れた": 0.039853495913072002621, "れば": 0.31153895902579281652, "ろう": 0.36940990058585265743, "われ": 0.039785092481029515898, "を通": -0.77673164826125185023, "んだ": 0.072951236162718882672, "んな": -0.49068198072913649099, "ネロ": 0.11841103137430385173, "時に": -0.048088642281573119874 };
  this.BW3__ = { "th": 0.014785593763562261682, "ある": 0.13310375016925429792, "いい": 0.31008839068298116315, "いっ": 0.16431525298342702923, "いる": 0.34800382728849665881, "う。": 0.070534343176289315824, "うと": 0.31866167883069906885, "うに": -0.029900648298729924635, "かっ": -0.22874121413214865139, "から": 0.50576800934038124158, "がら": -0.22728955724406427197, "きた": 0.024906818600566014293, "こと": 0.83012188739060643883, "この": 0.18255375382191693645, "ころ": -0.13558223779783018514, "しい": -0.1677740912277661256, "して": 0.015263140575872007759, "しま": 0.035511926532455537209, "す。": -0.53183279024031770987, "する": 0.39752057830889120371, "その": 0.13649861240561153575, "た。": 0.64896970419673505326, "たい": -0.28236599508263782177, "たの": 0.025206978381667972944, "った": -0.21211073549548098427, "てい": 0.62514962871276147371, "てく": 0.0098755910086658973968, "ての": -0.04041417590759684153, "です": 0.095174434814547390071, "とい": 0.067109657050959392599, "とも": -0.040293856905032419957, "ない": 0.33144951132192346233, "に、": -0.12208499196741522119, "には": 0.19462251313519998708, "のも": -0.093002112767795061532, "の子": -0.16195040731855131488, "まし": 0.18749985797178725377, "ます": 0.43310342622338521279, "まで": 0.17328823316166230839, "もの": 0.30945618614589942563, "られ": 0.58935879266868840265, "れた": 0.0048681592398596654908, "れて": 0.093625498683552438317, "れば": -0.16723829978226370518, "われ": -0.14133229841030695018 };
  this.TC1__ = { "HII": 0.039509601908841111839, "IHI": 0.02052735695537259708, "III": 0.066544872799077656178, "KKK": 0.063491361414140287667, "OII": -0.031868820246557405529 };
  this.TC2__ = { "AAA": -0.016005918818273009302, "HHH": -0.029378849325844603319, "IHI": -0.071106146590222379933, "IIH": -0.016170352776648039966, "III": -0.20594747316963274431, "KKI": 0.17714469717145875372, "OII": -0.37146316871702361739 };
  this.TC3__ = { "HHI": -0.0063248971749671773629, "HIH": -0.020158584286147668285, "HII": -0.10604638049997366922, "IHH": 0.11542307660916047152, "IHI": -0.11537969241996533232, "IIH": -0.26975662557204477254, "IIK": -0.039550477779396277234, "IKK": 0.15300450748074306828 };
  this.TC4__ = { "AAA": 0.32091550379474476085, "HHI": 0.11440645382177995482, "HIH": 0.055809293619016958621, "HII": -0.034065041329023576511, "HIO": -0.01030181531224085012, "IIH": -0.052620182619689322145, "III": 0.10566636150434548236, "IIO": 0.0055670862618160147847, "IOO": 0.031097809287524549871, "KKK": 0.19068665054756295252 };
  this.TQ1__ = { "BHII": -0.0058443301144429039493, "BIII": 0.060696986793574936314, "OHII": 0.083811476414894711673 };
  this.TQ2__ = { "BIIH": -0.06220959097166443158, "BOHI": -0.010577156786422341195, "OKHH": -0.0048774672786713983708 };
  this.TQ3__ = { "BHIH": 0.0062890974598072474019, "BHII": -0.016055419643626708814, "BIHI": 0.024502536390263375543, "OAAA": 0.16409758015977468637, "OHHI": 0.084210166183782880767, "OHII": 0.16095419786535039575, "OIII": -0.005605291187794991456, "OIKK": -0.033366709544757081063, "OKKK": 0.062587285013423699098, "OOHI": -0.033868567430034642041, "OOII": -0.098048968026386087993 };
  this.TQ4__ = { "BHHH": -0.19557578215931978316, "BHIH": 0.07227899769125703533, "BIII": -0.19875665931320665725, "OHIH": -0.61328465327188863565, "OHII": 0.0073237247315630464584, "OIHI": -0.24284706152466545293, "OIII": -0.11468853766020783991 };
  this.TW1__ = { "につい": -0.11623407099710712787, "によっ": -0.0049214959194489524275 };
  this.TW2__ = { "しょう": 0.11736167747307897635, "そして": -0.10587994014558690936, "として": -0.10148181720164659025, "まるで": -0.0048579922200363973017, "よって": -0.061069157157223732946, "ラグイ": 0.0048748734073001207673 };
  this.TW3__ = { "として": -0.086186725401944372371, "につい": -0.044954250244913354639, "にとっ": -0.19829323744820129272, "ので、": -0.1324625385222370777 };
  this.TW4__ = { "いうこ": 0.13506328593550318007, "した。": -0.12834388188812306808, "してい": 0.10322794990586325881, "ている": 0.056939023612352118731, "という": 0.035515718893578726578, "ました": 0.49706159063499633088, "ません": 0.30057524560441756245, "ようと": -0.25674416386060439077, "ように": 0.083095744000661553308 };
  this.UC1__ = { "A": 0.010156669149885798331, "I": -0.0085711726282472113642, "O": -0.068730219940923056865 };
  this.UC2__ = { "H": 0.34932452180126466468, "I": -0.015687705712196773483, "K": 0.08971465602179735932, "M": 0.27319336124300996893, "O": -0.081662848336904805824 };
  this.UC3__ = { "I": 0.08371628945944345479, "M": -0.47964660362344807565, "O": 1.0911901974166282603 };
  this.UC4__ = { "H": 0.066374123442206098278, "I": 0.032845000847053953952, "M": -0.15638593137367923225, "O": 0.78531870207327358901 };
  this.UC5__ = { "H": 0.13596051078311455207, "I": -0.078963248238673566792 };
  this.UC6__ = { "A": 0.033968993675558334377, "H": -0.015643629982255494865, "I": 0.04452334552336498219, "O": 0.086174907068345421579 };
  this.UP1__ = { "B": 0.0092462674633566454413, "O": 0.04032524460970510205, "U": -0.045165476684143432418 };
  this.UP2__ = { "O": -0.021233274644257438962 };
  this.UP3__ = { "O": 0.054005617990984647325 };
  this.UQ1__ = { "BK": 0.039034585991110974657, "OH": -0.0097317970667666463952, "OI": 0.015716070787727201563, "OK": -0.010762042776772420133, "UI": -0.05361508572751963464 };
  this.UQ2__ = { "OH": -0.10856293030493244234, "OK": 0.059444559365215920987 };
  this.UQ3__ = { "BH": -0.2470472980093390003, "BI": 0.39420861279764601859, "BK": -0.0058290976988708614534, "BO": 0.056086836682142975075 };
  this.UW1__ = { "B1": 0.018105810208910382009, "i": 0.0049467551300474326206, "、": -0.027775261898388338422, "が": -0.068660286437382977986, "こ": 0.058538528061442732242, "し": -0.010637833861056059104, "っ": 0.010453134870636749537, "と": -0.019201524518359821408, "に": -0.13465933626070342166, "の": -0.0056109621167006462628, "は": -0.15094814131442158001, "も": -0.041580553635757286357, "や": -0.0098980433841667995326, "よ": 0.094832004551459084252, "る": 0.0578240862836130326, "を": -0.064806857694675368275, "ー": 0.01620364064519715791 };
  this.UW2__ = { "、": -0.055937162762317776954, "。": -0.031738034837723055892, "」": 0.10666238720159240683, "い": 0.0099592793140721794232, "う": -0.013845031111581923219, "お": -0.0098877295501184937765, "か": 0.18113638014991276237, "が": -0.11288002491272736139, "く": -0.063927493301282736771, "こ": 0.22162968277951689, "さ": 0.040047180949087567148, "し": 0.13716382860877637806, "す": -0.026090438087067024248, "そ": -0.059586198118169918236, "た": 0.020886729291442758527, "だ": 0.11611864520977424609, "っ": 0.050711868664466468182, "て": -0.076419787529885277455, "と": -0.16176978167608430104, "な": 0.017725253098804766294, "に": -0.19583720954807687376, "の": 0.0052804083009183417838, "は": -0.16583007737131602588, "ま": 0.015742977125139934885, "も": -0.08534354771854774091, "よ": 0.078680702338215294245, "り": -0.042152274863661000348, "る": -0.13862747171796457879, "れ": 0.036180244374156643461, "を": -0.25567952871980176299, "ん": 0.21368356221248083204, "不": -0.16036148243901560129, "大": -0.31524207130817977207, "小": -0.12976577209782141908, "見": -0.26537350265591314047 };
  this.UW3__ = { "d": 0.12433623481840967717, "e": 0.070193529652913311256, "i": -0.28951833750199723605, "s": 0.079272620986535563548, "y": 0.029893323178321773437, "、": 0.62542408195435639229, "あ": -0.450431553372896476, "う": 0.27973983700002380548, "え": 0.14066336325934564178, "お": -0.53542495009055057764, "か": -0.15967315696317041507, "が": 0.33241232593651343086, "く": 0.1164039315633594307, "こ": -0.44323306448851035322, "ご": -0.19488686586101500176, "さ": -0.13214430661859372096, "し": -0.055734867050514724784, "せ": 0.32861188600632507129, "そ": -0.5733603024591940045, "た": 0.0062808447759596600785, "ち": -0.031016646716852683263, "っ": -0.0097402714878607257742, "つ": -0.07693292540999878415, "て": 0.64693731194115366989, "で": 0.056310982382675719982, "と": 0.12921676820941724317, "ど": -0.11593197232924046247, "な": -0.35446808222188946891, "に": 0.17894308086797011681, "の": 0.34962889282436176996, "は": 0.58198193806057219035, "ほ": -0.30559956525759152113, "ま": -0.54910437311874871202, "み": -0.010187140672554068771, "も": 0.14435269861292554516, "よ": -0.11981759986462114931, "り": 0.08408495596098593261, "る": 0.54176577357610622432, "れ": 0.2871329299726152473, "わ": -0.15263181238897241543, "を": 0.76557726249149649078, "グ": 0.040778032854860236933, "ニ": -0.024725575380353605887, "ネ": 0.34811388323224445873, "ル": 0.0098822072537442726126, "ン": 0.079400077678926345159, "二": 0.41310866547585806119, "人": 0.18029601537995929017, "何": 0.41148867757667562106, "大": 0.0098188387665694570883, "当": -0.32892885754291634193, "彼": 0.063672101716398352145, "数": 0.10642282655589906104, "的": 0.78366080723220910009, "私": 0.43373822185625171555, "立": -0.06189162474332259023, "第": 0.0097651508635867578789, "見": 0.0097806967559505957055 };
  this.UW4__ = { "e": -0.26241347443103024695, "n": -0.070436240349234569003, "r": -0.051747575089395432546, "、": 0.16534915089036275604, "あ": 0.60345467604683300511, "い": -0.33782388440806793151, "う": -0.10041222243216878229, "え": -0.46012258051344634424, "お": 0.081779332905360074824, "か": 0.042756554155529744032, "が": 0.64721561064721311318, "き": -0.412647521838881981, "く": -0.39041893824275031299, "け": -0.43736949785909517985, "こ": 0.11971486995369957917, "さ": 0.094733259902732153135, "し": -0.074054326481458210285, "じ": -0.078143184355614167536, "そ": 0.41404011633276427418, "た": 0.50051200629049719115, "だ": 0.51758597550079810112, "ち": -0.32757825436164694777, "っ": -0.63880905732193427049, "つ": -0.2121335661920838167, "て": 0.31898308477718639864, "で": 0.75487907089634143087, "と": 0.397848369699579818, "な": 0.53478046915084831436, "に": 0.62185098191448751059, "の": 0.85898381893258302089, "は": 0.95375909754955590092, "ば": 0.017967849736232246322, "び": -0.093911818578091180165, "へ": 0.37799889890659155167, "ほ": 0.14812264151642359766, "ま": 0.23513321500445438783, "め": -0.42889319923710472748, "も": 0.18698587166826777239, "ゃ": -0.18894731215972296323, "や": 0.18777123466555484255, "ょ": -0.26980073191275782962, "よ": 0.25773722317950720218, "ら": -0.40787500712261021141, "り": -0.88582171649816787706, "る": -1.1570270191745182231, "れ": -0.15783908494305104453, "ろ": -0.33551488818625196942, "わ": -0.0075555247504103095063, "を": 1.7596940538872138937, "ん": -0.025781378080716690904, "ソ": 0.17371020657951846689, "ッ": -0.083591877885791879277, "ド": 0.10155250329870883774, "ニ": -0.13628238659090971541, "ラ": 0.014834805312977447297, "ル": -0.014596613928525988338, "ン": -0.10443848315440722174, "ー": -0.53091409256658972371, "人": 0.22936106874668577005, "子": -0.040895766920985988924, "対": -0.18339524187952346845, "的": 0.27398041972945291755, "者": 0.024864512127211243347 };
  this.UW5__ = { "a": 0.010179122517861592667, "h": 0.11342004850022312235, "o": 0.13864114348404826815, "t": -0.061948467393908489276, "、": -0.040769958221064474257, "。": 0.076416411387003099764, "あ": 0.068869198720176785788, "い": 0.016030129173308378665, "か": 0.076840251693580816084, "が": -0.033224533459436086935, "き": 0.1863415532170790978, "さ": -0.15249439853060661743, "し": -0.018745999550093317421, "た": 0.015809063975165196791, "ち": 0.1346936330508620161, "つ": 0.026609177144296267126, "て": -0.04656375038864669913, "で": -0.030324895992921888088, "と": 0.1190584248578121368, "な": -0.059856730513047205766, "に": -0.1416691644433055175, "も": -0.042507616269688734689, "ゃ": 0.17410553608770115708, "り": -0.0050470440321248501853, "る": 0.10016299227257019488, "れ": 0.096268810011308589281, "を": -0.061036901279725497282, "ン": 0.17020227093870649027, "ー": 0.085698011508523824764, "度": -0.061197253572076518169, "的": -0.31840034899741120888 };
  this.UW6__ = { "、": -0.056193246304755473108, "あ": -0.010118654468238390265, "い": 0.0049232787057809897571, "か": 0.010776371652764536735, "た": -0.0050782607755864243165, "だ": 0.0051204302167303381368, "っ": 0.014769316557906187609, "て": -0.22052003590762858654, "と": -0.083289534643893187171, "の": -0.036939222540452613941, "は": -0.045659223347292526851, "も": -0.010294320384416674741, "れ": -0.0051656537872381341411 };

  return this;
}

TinySegmenter.prototype.ctype_ = function (str) {
  for (var i in this.chartype_) {
    if (str.match(this.chartype_[i][0])) {
      return this.chartype_[i][1];
    }
  }
  return "O";
}

TinySegmenter.prototype.ts_ = function (v) {
  if (v) { return v; }
  return 0;
}

TinySegmenter.prototype.segment = function (input) {
  if (input == null || input == undefined || input == "") {
    return [];
  }
  var result = [];
  var seg = ["B3", "B2", "B1"];
  var ctype = ["O", "O", "O"];
  var o = input.split("");
  for (i = 0; i < o.length; ++i) {
    seg.push(o[i]);
    ctype.push(this.ctype_(o[i]))
  }
  seg.push("E1");
  seg.push("E2");
  seg.push("E3");
  ctype.push("O");
  ctype.push("O");
  ctype.push("O");
  var word = seg[3];
  var p1 = "U";
  var p2 = "U";
  var p3 = "U";
  for (var i = 4; i < seg.length - 3; ++i) {
    var score = this.BIAS__;
    var w1 = seg[i - 3];
    var w2 = seg[i - 2];
    var w3 = seg[i - 1];
    var w4 = seg[i];
    var w5 = seg[i + 1];
    var w6 = seg[i + 2];
    var c1 = ctype[i - 3];
    var c2 = ctype[i - 2];
    var c3 = ctype[i - 1];
    var c4 = ctype[i];
    var c5 = ctype[i + 1];
    var c6 = ctype[i + 2];
    score += this.ts_(this.UP1__[p1]);
    score += this.ts_(this.UP2__[p2]);
    score += this.ts_(this.UP3__[p3]);
    score += this.ts_(this.BP1__[p1 + p2]);
    score += this.ts_(this.BP2__[p2 + p3]);
    score += this.ts_(this.UW1__[w1]);
    score += this.ts_(this.UW2__[w2]);
    score += this.ts_(this.UW3__[w3]);
    score += this.ts_(this.UW4__[w4]);
    score += this.ts_(this.UW5__[w5]);
    score += this.ts_(this.UW6__[w6]);
    score += this.ts_(this.BW1__[w2 + w3]);
    score += this.ts_(this.BW2__[w3 + w4]);
    score += this.ts_(this.BW3__[w4 + w5]);
    score += this.ts_(this.TW1__[w1 + w2 + w3]);
    score += this.ts_(this.TW2__[w2 + w3 + w4]);
    score += this.ts_(this.TW3__[w3 + w4 + w5]);
    score += this.ts_(this.TW4__[w4 + w5 + w6]);
    score += this.ts_(this.UC1__[c1]);
    score += this.ts_(this.UC2__[c2]);
    score += this.ts_(this.UC3__[c3]);
    score += this.ts_(this.UC4__[c4]);
    score += this.ts_(this.UC5__[c5]);
    score += this.ts_(this.UC6__[c6]);
    score += this.ts_(this.BC1__[c2 + c3]);
    score += this.ts_(this.BC2__[c3 + c4]);
    score += this.ts_(this.BC3__[c4 + c5]);
    score += this.ts_(this.TC1__[c1 + c2 + c3]);
    score += this.ts_(this.TC2__[c2 + c3 + c4]);
    score += this.ts_(this.TC3__[c3 + c4 + c5]);
    score += this.ts_(this.TC4__[c4 + c5 + c6]);
    //  score += this.ts_(this.TC5__[c4 + c5 + c6]);    
    score += this.ts_(this.UQ1__[p1 + c1]);
    score += this.ts_(this.UQ2__[p2 + c2]);
    score += this.ts_(this.UQ3__[p3 + c3]);
    score += this.ts_(this.BQ1__[p2 + c2 + c3]);
    score += this.ts_(this.BQ2__[p2 + c3 + c4]);
    score += this.ts_(this.BQ3__[p3 + c2 + c3]);
    score += this.ts_(this.BQ4__[p3 + c3 + c4]);
    score += this.ts_(this.TQ1__[p2 + c1 + c2 + c3]);
    score += this.ts_(this.TQ2__[p2 + c2 + c3 + c4]);
    score += this.ts_(this.TQ3__[p3 + c1 + c2 + c3]);
    score += this.ts_(this.TQ4__[p3 + c2 + c3 + c4]);
    var p = "O";
    if (score > 0) {
      result.push(word);
      word = "";
      p = "B";
    }
    p1 = p2;
    p2 = p3;
    p3 = p;
    word += seg[i];
  }
  result.push(word);

  return result;
}
